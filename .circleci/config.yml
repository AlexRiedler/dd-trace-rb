# Common variables, containers, jobs and steps.
job_defaults: &job_defaults
  working_directory: /app
  shell: /bin/bash --login

ruby_containers: &ruby_containers
  - &container-1_9
    image: datadog/docker-library:ddtrace_rb_1_9_3
    environment:
      - BUNDLE_GEMFILE=/app/Gemfile
  - &container-2_0
    image: datadog/docker-library:ddtrace_rb_2_0_0
    environment:
      - BUNDLE_GEMFILE=/app/Gemfile
  - &container-2_1
    image: datadog/docker-library:ddtrace_rb_2_1_10
    environment:
      - BUNDLE_GEMFILE=/app/Gemfile
  - &container-2_2
    image: datadog/docker-library:ddtrace_rb_2_2_10
    environment:
      - BUNDLE_GEMFILE=/app/Gemfile
  - &container-2_3
    image: datadog/docker-library:ddtrace_rb_2_3_7
    environment:
      - BUNDLE_GEMFILE=/app/Gemfile
  - &container-2_4
    image: datadog/docker-library:ddtrace_rb_2_4_4
    environment:
      - BUNDLE_GEMFILE=/app/Gemfile

test_containers: &test_containers
  - &container_postgres
    image: postgres:9.6
    environment:
      - POSTGRES_PASSWORD=postgres
      - POSTGRES_USER=postgres
      - POSTGRES_DB=postgres
  - &container_mysql
    image: mysql:5.6
    environment:
      - MYSQL_ROOT_PASSWORD=root
      - MYSQL_PASSWORD=mysql
      - MYSQL_USER=mysql
  - &container_elasticsearch
    image: elasticsearch:2.4
  - &container_redis
    image: redis:3.0
  - &container_mongo
    image: mongo:3.5
  - &container_memcached
    image: memcached:1.5-alpine
  - &container_agent
    image: datadog/docker-dd-agent
    environment:
      - DD_APM_ENABLED=true
      - DD_BIND_HOST=0.0.0.0
      - DD_API_KEY=invalid_key_but_this_is_fine

step_init_bundle_checksum: &step_init_bundle_checksum
  run:
    name: Initialize bundle cache key
    command: |
      touch .circleci/bundle_checksum
step_bundle_install: &step_bundle_install
  run:
    name: Install gem dependencies
    command: bundle install --path vendor/bundle
step_rubocop: &step_rubocop
  run:
    name: Delint with Rubocop
    command: bundle exec rake rubocop
step_appraisal_install: &step_appraisal_install
  run:
    name: Install Appraisal gems
    command: bundle exec appraisal install
step_compute_bundle_checksum: &step_compute_bundle_checksum
  run:
    name: Compute bundle checksum
    command: |
      cat Gemfile.lock gemfiles/*.gemfile.lock > .circleci/bundle_checksum
step_run_all_tests: &step_run_all_tests
  run:
    name: Run tests
    command: bundle exec rake ci
step_release_docs: &step_release_docs
  run:
    name: Upload release docs
    command: S3_DIR=trace bundle exec rake release:docs

filters_all_branches_and_tags: &filters_all_branches_and_tags
  filters:
    tags:
      only: /.*/
filters_only_release_tags: &filters_only_release_tags
  filters:
    branches:
      ignore: /.*/
    tags:
      only: /^v\d+(\.\d+){0,3}(\.(alpha|beta|rc)\d+)?$/

version: 2.0

build_job: &build_job
  <<: *job_defaults
  steps:
    - checkout
    - attach_workspace:
        at: /app
    - restore_cache:
        key: 'betav2-bundle-{{ .Environment.CIRCLE_JOB }}-{{ checksum "Gemfile" }}-{{ checksum "Appraisals" }}'
    - *step_bundle_install
    - *step_appraisal_install
    - save_cache:
        key: 'betav2-bundle-{{ .Environment.CIRCLE_JOB }}-{{ checksum "Gemfile" }}-{{ checksum "Appraisals" }}'
        paths:
          - vendor/bundle
          - gemfiles/
    - persist_to_workspace:
              root: .
              paths:
                - vendor/bundle
                - gemfiles/
                - Gemfile.lock

test_job: &test_job
  <<: *job_defaults
  steps:
    - checkout
    - attach_workspace:
        at: /app
    - run: bundle --path vendor/bundle
    - *step_run_all_tests

linting_job: &linting_job
  <<: *job_defaults
  steps:
    - checkout
    - attach_workspace:
        at: /app
    - run: bundle --path vendor/bundle
    - step_rubocop

jobs:
  build-1.9:
    <<: *build_job
    docker:
      - *container-1_9
  test-1.9:
    <<: *test_job
    docker:
      - <<: *container-1_9
        environment:
          - TEST_DATADOG_INTEGRATION: 1
      - *container_postgres
      - *container_mysql
      - *container_elasticsearch
      - *container_redis
      - *container_mongo
      - *container_memcached
      - *container_agent
  lint-1.9:
    <<: *linting_job
    docker:
      - *container-1_9
  build-2.0:
    <<: *build_job
    docker:
      - *container-2_0
  test-2.0:
    <<: *test_job
    docker:
      - <<: *container-2_0
        environment:
          - TEST_DATADOG_INTEGRATION: 1
      - *container_postgres
      - *container_mysql
      - *container_elasticsearch
      - *container_redis
      - *container_mongo
      - *container_memcached
      - *container_agent
  lint-2.0:
    <<: *linting_job
    docker:
      - *container-2_0
  build-2.1:
    <<: *build_job
    docker:
      - *container-2_1
  test-2.1:
    <<: *test_job
    docker:
      - <<: *container-2_1
        environment:
          - TEST_DATADOG_INTEGRATION: 1
      - *container_postgres
      - *container_mysql
      - *container_elasticsearch
      - *container_redis
      - *container_mongo
      - *container_memcached
      - *container_agent
  lint-2.1:
    <<: *linting_job
    docker:
      - *container-2_1
  build-2.2:
    <<: *build_job
    docker:
      - *container-2_2
  test-2.2:
    <<: *test_job
    docker:
      - <<: *container-2_2
        environment:
          - TEST_DATADOG_INTEGRATION: 1
      - *container_postgres
      - *container_mysql
      - *container_elasticsearch
      - *container_redis
      - *container_mongo
      - *container_memcached
      - *container_agent
  lint-2.2:
    <<: *linting_job
    docker:
      - *container-2_2
  build-2.3:
    <<: *build_job
    docker:
      - *container-2_3
  test-2.3:
    <<: *test_job
    docker:
      - <<: *container-2_3
        environment:
          - TEST_DATADOG_INTEGRATION: 1
      - *container_postgres
      - *container_mysql
      - *container_elasticsearch
      - *container_redis
      - *container_mongo
      - *container_memcached
      - *container_agent
  lint-2.3:
    <<: *linting_job
    docker:
      - *container-2_3
  build-2.4:
    <<: *build_job
    docker:
      - *container-2_4
  test-2.4:
    <<: *test_job
    docker:
      - <<: *container-2_4
        environment:
          - TEST_DATADOG_INTEGRATION: 1
      - *container_postgres
      - *container_mysql
      - *container_elasticsearch
      - *container_redis
      - *container_mongo
      - *container_memcached
      - *container_agent
  lint-2.4:
    <<: *linting_job
    docker:
      - *container-2_4

  deploy-release:
    <<: *job_defaults
    docker:
      - *container-2_4
    steps:
      - checkout
      - run:
          command: |
            apt-get -y -qq update
            apt-get -y -qq install awscli
      - restore_cache:
          key: 'v1-bundle-2.4'
      - run:
          name: Install gem dependencies
          command: bundle install
      - save_cache:
          key: 'v1-bundle-2.4'
          paths:
            - /usr/local/bundle
      - *step_release_docs

workflows:
  version: 2
  build-and-test:
    jobs:
      - build-1.9:
          <<: *filters_all_branches_and_tags
      - test-1.9:
          <<: *filters_all_branches_and_tags
          requires:
            - build-1.9
      - build-2.0:
          <<: *filters_all_branches_and_tags
      - test-2.0:
          <<: *filters_all_branches_and_tags
          requires:
            - build-2.0
      - build-2.1:
          <<: *filters_all_branches_and_tags
      - test-2.1:
          <<: *filters_all_branches_and_tags
          requires:
            - build-2.1
      - build-2.2:
          <<: *filters_all_branches_and_tags
      - test-2.2:
          <<: *filters_all_branches_and_tags
          requires:
            - build-2.2
      - build-2.3:
          <<: *filters_all_branches_and_tags
      - test-2.3:
          <<: *filters_all_branches_and_tags
          requires:
            - build-2.3
      - build-2.4:
          <<: *filters_all_branches_and_tags
      - test-2.4:
          <<: *filters_all_branches_and_tags
          requires:
            - build-2.4
      - deploy-release:
          <<: *filters_only_release_tags
          requires:
            - test-1.9
#            - test-2.0
#            - test-2.1
#            - test-2.2
#            - test-2.3
#            - test-2.4
